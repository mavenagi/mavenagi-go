// Code generated by Fern. DO NOT EDIT.

package knowledge_test

import (
	bytes "bytes"
	context "context"
	json "encoding/json"
	mavenagigo "github.com/mavenagi/mavenagi-go"
	client "github.com/mavenagi/mavenagi-go/client"
	option "github.com/mavenagi/mavenagi-go/option"
	require "github.com/stretchr/testify/require"
	http "net/http"
	testing "testing"
)

func ResetWireMockRequests(
	t *testing.T,
) {
	WiremockAdminURL := "http://localhost:8080/__admin"
	_, err := http.Post(WiremockAdminURL+"/requests/reset", "application/json", nil)
	require.NoError(t, err)
}

func VerifyRequestCount(
	t *testing.T,
	method string,
	urlPath string,
	queryParams map[string]string,
	expected int,
) {
	WiremockAdminURL := "http://localhost:8080/__admin"
	var reqBody bytes.Buffer
	reqBody.WriteString(`{"method":"`)
	reqBody.WriteString(method)
	reqBody.WriteString(`","urlPath":"`)
	reqBody.WriteString(urlPath)
	reqBody.WriteString(`"}`)
	if len(queryParams) > 0 {
		reqBody.WriteString(`,"queryParameters":{`)
		first := true
		for key, value := range queryParams {
			if !first {
				reqBody.WriteString(",")
			}
			reqBody.WriteString(`"`)
			reqBody.WriteString(key)
			reqBody.WriteString(`":{"equalTo":"`)
			reqBody.WriteString(value)
			reqBody.WriteString(`"}`)
			first = false
		}
		reqBody.WriteString("}")
	}
	resp, err := http.Post(WiremockAdminURL+"/requests/find", "application/json", &reqBody)
	require.NoError(t, err)
	var result struct {
		Requests []interface{} `json:"requests"`
	}
	json.NewDecoder(resp.Body).Decode(&result)
	require.Equal(t, expected, len(result.Requests))
}

func TestKnowledgeSearchKnowledgeBasesWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseSearchRequest{}
	_, invocationErr := client.Knowledge.SearchKnowledgeBases(
		context.TODO(),
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/search", nil, 1)
}

func TestKnowledgeCreateOrUpdateKnowledgeBaseWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseRequest{
		KnowledgeBaseID: &mavenagigo.EntityIDBase{
			ReferenceID: "help-center",
		},
		Name: "Help center",
	}
	_, invocationErr := client.Knowledge.CreateOrUpdateKnowledgeBase(
		context.TODO(),
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "PUT", "/v1/knowledge", nil, 1)
}

func TestKnowledgeGetKnowledgeBaseWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseGetRequest{}
	_, invocationErr := client.Knowledge.GetKnowledgeBase(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "GET", "/v1/knowledge/help-center", nil, 1)
}

func TestKnowledgeRefreshKnowledgeBaseWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseRefreshRequest{
		AppID: mavenagigo.String(
			"readme",
		),
	}
	invocationErr := client.Knowledge.RefreshKnowledgeBase(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/help-center/refresh", nil, 1)
}

func TestKnowledgePatchKnowledgeBaseWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBasePatchRequest{
		Name: mavenagigo.String(
			"Updated Help Center",
		),
		Tags: []string{
			"tag1",
			"tag2",
			"tag3",
		},
		SegmentID: &mavenagigo.EntityID{
			ReferenceID:    "premium-users",
			AppID:          "readme",
			OrganizationID: "acme",
			AgentID:        "support",
			Type:           mavenagigo.EntityTypeSegment,
		},
	}
	_, invocationErr := client.Knowledge.PatchKnowledgeBase(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "PATCH", "/v1/knowledge/help-center", nil, 1)
}

func TestKnowledgeCreateKnowledgeBaseVersionWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseVersionRequest{
		Type: mavenagigo.KnowledgeBaseVersionTypeFull,
	}
	_, invocationErr := client.Knowledge.CreateKnowledgeBaseVersion(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/help-center/version", nil, 1)
}

func TestKnowledgeFinalizeKnowledgeBaseVersionWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.FinalizeKnowledgeBaseVersionRequest{
		VersionID: &mavenagigo.EntityIDWithoutAgent{
			Type:        mavenagigo.EntityTypeKnowledgeBaseVersion,
			ReferenceID: "versionId",
			AppID:       "maven",
		},
		Status: mavenagigo.KnowledgeBaseVersionFinalizeStatusSucceeded.Ptr(),
	}
	_, invocationErr := client.Knowledge.FinalizeKnowledgeBaseVersion(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/help-center/version/finalize", nil, 1)
}

func TestKnowledgeListKnowledgeBaseVersionsWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeBaseVersionsListRequest{}
	_, invocationErr := client.Knowledge.ListKnowledgeBaseVersions(
		context.TODO(),
		"knowledgeBaseReferenceId",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "GET", "/v1/knowledge/knowledgeBaseReferenceId/versions", nil, 1)
}

func TestKnowledgeSearchKnowledgeDocumentsWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeDocumentSearchRequest{}
	_, invocationErr := client.Knowledge.SearchKnowledgeDocuments(
		context.TODO(),
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/documents/search", nil, 1)
}

func TestKnowledgeCreateKnowledgeDocumentWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeDocumentRequest{
		KnowledgeDocumentID: &mavenagigo.EntityIDBase{
			ReferenceID: "getting-started",
		},
		VersionID: &mavenagigo.EntityIDWithoutAgent{
			Type:        mavenagigo.EntityTypeKnowledgeBaseVersion,
			ReferenceID: "versionId",
			AppID:       "maven",
		},
		ContentType: mavenagigo.KnowledgeDocumentContentTypeMarkdown,
		Content: mavenagigo.String(
			"## Getting started\nThis is a getting started guide for the help center.",
		),
		Title: "Getting started",
		Metadata: map[string]string{
			"category": "getting-started",
		},
	}
	_, invocationErr := client.Knowledge.CreateKnowledgeDocument(
		context.TODO(),
		"help-center",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "POST", "/v1/knowledge/help-center/document", nil, 1)
}

func TestKnowledgeDeleteKnowledgeDocumentWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeDeleteRequest{
		VersionID: &mavenagigo.EntityIDWithoutAgent{
			Type:        mavenagigo.EntityTypeKnowledgeBaseVersion,
			AppID:       "maven",
			ReferenceID: "versionId",
		},
	}
	invocationErr := client.Knowledge.DeleteKnowledgeDocument(
		context.TODO(),
		"help-center",
		"getting-started",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "DELETE", "/v1/knowledge/help-center/getting-started/document", nil, 1)
}

func TestKnowledgeGetKnowledgeDocumentWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeDocumentGetRequest{
		KnowledgeBaseVersionAppID: "knowledgeBaseVersionAppId",
	}
	_, invocationErr := client.Knowledge.GetKnowledgeDocument(
		context.TODO(),
		"knowledgeBaseVersionReferenceId",
		"knowledgeDocumentReferenceId",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "GET", "/v1/knowledge/versions/knowledgeBaseVersionReferenceId/documents/knowledgeDocumentReferenceId", map[string]string{"knowledgeBaseVersionAppId": "knowledgeBaseVersionAppId"}, 1)
}

func TestKnowledgePatchKnowledgeDocumentWithWireMock(
	t *testing.T,
) {
	ResetWireMockRequests(t)
	WireMockBaseURL := "http://localhost:8080"
	client := client.NewMavenAGI(
		option.WithBaseURL(
			WireMockBaseURL,
		),
	)
	request := &mavenagigo.KnowledgeDocumentPatchRequest{
		LlmInclusionStatus: mavenagigo.LlmInclusionStatusAlways.Ptr(),
	}
	_, invocationErr := client.Knowledge.PatchKnowledgeDocument(
		context.TODO(),
		"help-center",
		"how-it-works",
		request,
	)

	require.NoError(t, invocationErr, "Client method call should succeed")
	VerifyRequestCount(t, "PATCH", "/v1/knowledge/help-center/how-it-works/document", nil, 1)
}
